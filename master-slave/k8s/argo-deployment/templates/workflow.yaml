{{- range $role, $namespace := .Values.namespaces }}
---
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  name: job-sequence-workflow
  namespace: {{ $namespace }}
  labels:
    role: {{ $role }}
spec:
  entrypoint: sequential-jobs
  serviceAccountName: argo-workflow
  
  volumeClaimTemplates:
  - metadata:
      name: workdir
    spec:
      accessModes: [ReadWriteOnce]
      storageClassName: ebs-gp3
      resources:
        requests:
          storage: 1Gi
  
  templates:
  - name: sequential-jobs
    steps:
    - - name: run-job-a
        template: job-a
    - - name: run-job-b
        template: job-b
    - - name: run-job-c
        template: job-c
  
  {{- range $job := list "A" "B" "C" }}
  - name: job-{{ lower $job }}
    initContainers:
    - name: wait-for-postgres
      image: postgres:15-alpine
      command:
      - sh
      - -c
      - |
        until pg_isready -h postgres-service.{{ $namespace }}.svc.cluster.local -U postgres; do
          echo "Waiting for PostgreSQL..."
          sleep 2
        done
        echo "PostgreSQL is ready!"
    container:
      image: {{ $.Values.registry }}/{{ $.Values.repository }}:job-{{ lower $job }}-latest
      env:
      {{- include "postgres.env" $namespace | nindent 6 }}
      resources:
        {{- toYaml $.Values.resources.jobs | nindent 8 }}
  {{- end }}
{{- end }}

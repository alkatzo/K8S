{{- range $role, $namespace := .Values.namespaces }}
---
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  name: job-sequence-workflow
  namespace: {{ $namespace }}
  labels:
    role: {{ $role }}
spec:
  entrypoint: sequential-jobs
  serviceAccountName: argo-workflow
  
  templates:
  - name: sequential-jobs
    steps:
    # Run jobs sequentially (postgres should already be running via StatefulSet)
    - - name: run-job-a
        template: job-a
    - - name: run-job-b
        template: job-b
    - - name: run-job-c
        template: job-c
  
  # Job templates without initContainers
  {{- range $job := list "A" "B" "C" }}
  - name: job-{{ lower $job }}
    {{- if $.Values.enableZoneAffinity }}
    {{- $zone := index $.Values.zones $role }}
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
          - matchExpressions:
            - key: topology.kubernetes.io/zone
              operator: In
              values:
              - {{ $zone }}
    {{- end }}
    container:
      image: {{ $.Values.registry }}/{{ $.Values.repository }}:job-{{ lower $job }}-latest
      command: ["python", "app.py"]
      env:
      {{- include "postgres.env" $namespace | nindent 6 }}
      resources:
        {{- toYaml $.Values.resources.jobs | nindent 8 }}
  {{- end }}
{{- end }}
